# Maestro E2E Tests for Android TWA
# Runs Maestro tests against the Saberloop APK on an Android emulator
#
# TRIGGER: Label-based to avoid 20+ min runs on every PR
# - Add label "maestro-test" to a PR to trigger tests
# - Manual trigger via workflow_dispatch always available
# - Does NOT run automatically on push/PR (too slow)

name: Maestro E2E Tests

on:
  pull_request:
    branches: [main]
    types: [labeled]
  workflow_dispatch: # Allow manual trigger

jobs:
  maestro-tests:
    # Only run if label is "maestro-test" or manual trigger
    if: github.event.label.name == 'maestro-test' || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: AVD cache
        uses: actions/cache@v4
        id: avd-cache
        with:
          path: |
            ~/.android/avd/*
            ~/.android/adb*
          key: avd-api-30-${{ runner.os }}

      - name: Create AVD and generate snapshot
        if: steps.avd-cache.outputs.cache-hit != 'true'
        uses: reactivecircus/android-emulator-runner@v2
        with:
          api-level: 30
          arch: x86_64
          force-avd-creation: false
          emulator-options: -no-window -gpu swiftshader_indirect -noaudio -no-boot-anim -camera-back none
          disable-animations: true
          script: echo "Generated AVD snapshot for caching"

      - name: Install Maestro CLI
        run: |
          curl -Ls "https://get.maestro.mobile.dev" | bash
          echo "$HOME/.maestro/bin" >> $GITHUB_PATH

      - name: Verify Maestro installation
        run: |
          export PATH="$HOME/.maestro/bin:$PATH"
          maestro --version

      - name: Run Maestro tests
        uses: reactivecircus/android-emulator-runner@v2
        with:
          api-level: 30
          arch: x86_64
          force-avd-creation: false
          emulator-options: -no-window -gpu swiftshader_indirect -noaudio -no-boot-anim -camera-back none
          disable-animations: true
          script: |
            # Install the APK
            adb install "package/Saberloop - Google Play package/Saberloop.apk"

            # Wait for app to be installed
            sleep 5

            # Run Maestro tests (exclude offline test which can be flaky in CI)
            export PATH="$HOME/.maestro/bin:$PATH"
            maestro test .maestro/flows/01-onboarding.yaml --format junit --output maestro-results-01.xml || true
            maestro test .maestro/flows/02-quiz-flow.yaml --format junit --output maestro-results-02.xml || true
            maestro test .maestro/flows/03-quiz-results.yaml --format junit --output maestro-results-03.xml || true
            maestro test .maestro/flows/04-replay-quiz.yaml --format junit --output maestro-results-04.xml || true
            maestro test .maestro/flows/05-navigation.yaml --format junit --output maestro-results-05.xml || true
            maestro test .maestro/flows/06-settings.yaml --format junit --output maestro-results-06.xml || true
            # Note: 07-offline.yaml excluded due to airplane mode flakiness in CI
            maestro test .maestro/flows/09-quiz-sharing.yaml --format junit --output maestro-results-09.xml || true
            maestro test .maestro/flows/10-history-share.yaml --format junit --output maestro-results-10.xml || true

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: maestro-results
          path: |
            maestro-results-*.xml
            ~/.maestro/tests/
          retention-days: 14

      - name: Upload screenshots
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: maestro-screenshots
          path: ~/.maestro/tests/**/screenshots/
          retention-days: 14

      - name: Publish Test Results
        uses: dorny/test-reporter@v1
        if: always()
        with:
          name: Maestro Test Results
          path: 'maestro-results-*.xml'
          reporter: java-junit
          fail-on-error: false
