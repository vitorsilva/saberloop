# Issue #89: Make quiz/explanation JSON parsing more robust

## Problem Statement

LLM responses are frequently failing to parse, causing quiz generation and explanation failures:
- "Failed to generate questions": 17 occurrences (9 sessions)
- "Failed to parse explanation JSON": 11 occurrences (6 sessions)
- **Total: 30 errors across 12+ sessions**

The LLM occasionally returns:
1. JSON wrapped in markdown code blocks
2. Extra text before/after JSON
3. Smart quotes instead of straight quotes
4. BOM characters at the start

## Root Cause Analysis

Current parsing logic in `api.real.js`:
- `generateQuestions`: Basic markdown handling, no smart quote support
- `generateExplanation`: More robust, but logic is duplicated

The parsing code is:
1. **Inconsistent** between functions
2. **Missing fallbacks** for edge cases
3. **No telemetry** on raw response when parsing fails

## Solution Design

### 1. Create shared `extractJSON` utility (`src/utils/json-extractor.js`)

A single utility function with multiple fallback strategies:

```javascript
function extractJSON(text) {
  // 1. Remove BOM if present
  // 2. Try direct parse
  // 3. Fallback: Extract from markdown code block
  // 4. Fallback: Find JSON object/array in text
  // 5. Handle smart quotes
  // 6. Log raw text on all failures
}
```

### 2. Apply to both functions in `api.real.js`

Replace duplicated parsing logic with `extractJSON` calls.

### 3. Add telemetry

Log raw response text when parsing fails (truncated to 500 chars) for debugging.

## Files to Change

| File | Action |
|------|--------|
| `src/utils/json-extractor.js` | **Create** - JSON extraction utility |
| `src/utils/json-extractor.test.js` | **Create** - unit tests |
| `src/api/api.real.js` | **Modify** - use extractJSON utility |

## Testing Plan

### Unit Tests (json-extractor.js)
- [x] Parses clean JSON directly
- [x] Extracts JSON from ```json code blocks
- [x] Extracts JSON from ``` code blocks (no language)
- [x] Removes BOM characters
- [x] Converts smart quotes to straight quotes
- [x] Extracts JSON object from text with prefix/suffix
- [x] Extracts JSON array from text
- [x] Handles nested JSON correctly
- [x] Throws on truly invalid JSON
- [x] Handles truncated JSON gracefully

### Integration Tests
- [x] generateQuestions uses extractJSON
- [x] generateExplanation uses extractJSON

## Implementation Steps

- [x] 1. Write failing tests for extractJSON
- [x] 2. Implement `src/utils/json-extractor.js`
- [x] 3. Tests pass
- [x] 4. Integrate into `api.real.js`
- [x] 5. All tests pass
- [x] 6. Create PR

## Acceptance Criteria

From issue #89:
- [x] JSON extraction with fallback strategies
- [x] Raw response logged on parse failure (for debugging)
- [x] Unit tests for JSON extraction edge cases
- [ ] Parse error rate decreases in subsequent telemetry reports (post-deploy)
