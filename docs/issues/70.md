# Issue #70: Explanation modal shows raw JSON instead of parsed content

**Issue:** https://github.com/vitorsilva/saberloop/issues/70
**Branch:** `fix/issue-70-json-parsing`
**Created:** 2026-01-03

---

## Problem Statement

The explanation modal sometimes displays raw JSON instead of properly parsed explanation content. The console shows `[ERROR] Failed to parse explanation JSON`.

**Before screenshot:** See issue #70 on GitHub

---

## Root Cause Analysis

Looking at `src/api/api.real.js` lines 204-224:

1. The LLM returns JSON that should be valid
2. The parsing logic fails for some reason
3. The fallback (lines 220-224) returns the raw text as `rightAnswerExplanation`
4. The modal displays this raw JSON string

**Possible causes for JSON parse failure:**
1. Hidden characters (BOM, zero-width spaces, etc.)
2. Smart/curly quotes instead of straight quotes
3. Additional whitespace or newlines
4. The LLM wrapping JSON in something other than ```json code blocks
5. Non-standard JSON formatting

---

## Solution Design

### Approach: Improve JSON extraction robustness

1. **More aggressive cleanup before parsing:**
   - Strip BOM and other invisible characters
   - Normalize quotes (smart quotes â†’ straight quotes)
   - Try to extract JSON from anywhere in the response using regex

2. **Better fallback handling:**
   - If raw text looks like JSON (starts with `{`), try harder to parse
   - If truly unparseable, return a generic error message instead of raw JSON

3. **Add validation:**
   - Verify the extracted object has the expected fields
   - Ensure the values are strings, not nested objects

---

## Files to Change

| File | Change |
|------|--------|
| `src/api/api.real.js` | Improve JSON extraction in `generateExplanation()` |

---

## Testing Plan

### Unit Test (write first - TDD)

Create a test that reproduces the bug with various malformed LLM responses:
- JSON with BOM character
- JSON with smart quotes
- JSON wrapped in unexpected text
- JSON with leading/trailing whitespace

### Manual Testing

- [ ] Generate explanation in Portuguese
- [ ] Generate explanation in English
- [ ] Verify no raw JSON shown
- [ ] Check console for errors

---

## Checklist

### Setup
- [x] Create GitHub issue (#70)
- [x] Create fix branch
- [x] Create plan document
- [x] Capture "before" screenshot (in GitHub issue)

### Implementation
- [x] Write failing test (7 new tests, 2 failed initially)
- [x] Implement fix
- [x] Run tests

### Validation
- [x] Unit tests pass (363 total)
- [x] E2E tests pass (67 passed)
- [x] Type check passes
- [x] Architecture tests pass
- [ ] Manual testing complete
- [ ] Capture "after" screenshot

### Release
- [ ] Create PR
- [ ] Merge after approval
- [ ] Deploy to production

---

## Implementation Notes

### Fix 1: JSON Parsing (2026-01-03)

Updated `src/api/api.real.js` `generateExplanation()` function:

1. **BOM removal**: Strip Unicode BOM character if present at start
2. **JSON extraction**: Use regex to find JSON object when there's extra text before/after
3. **Smart quote normalization**: Replace curly quotes with straight quotes
4. **Better fallback**: Return empty strings instead of raw JSON on parse failure

**Commits:**
- `bf33656` - test: add failing tests for explanation JSON parsing (issue #70)
- `860ab7d` - fix(api): improve JSON extraction for explanation responses (#70)

### Fix 2: Reasoning Models (2026-01-03)

**Problem:** Some models (deepseek-r1t2-chimera) return response in `reasoning` field instead of `content`.

**Root cause:** `src/api/openrouter-client.js` line 53 only checks `content` field:
```javascript
const text = data.choices?.[0]?.message?.content;
if (!text) {
  throw new Error('Empty response from OpenRouter');
}
```

**Solution:** Check `reasoning` field as fallback when `content` is empty.

**Commits:**
- `bf374c3` - test: add tests for reasoning model response handling (#70)
- `1612cd5` - fix(api): use reasoning field when content is empty (#70)
