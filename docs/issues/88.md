# Issue #88: Add retry logic with exponential backoff for API calls

## Problem Statement

Network-related errors are causing quiz generation and explanation failures:
- "Failed to fetch explanation": 9 occurrences
- "Failed to fetch" (quiz generation): 2 occurrences
- Sessions affected: 5+
- 52% of errors on `/results` page, 41% on `/loading` page

## Root Cause Analysis

The `callOpenRouter` function in `src/api/openrouter-client.js` makes a single fetch attempt and fails immediately on network errors. Transient network issues (brief connectivity drops, timeouts) cause permanent failures when a simple retry would succeed.

**Current flow:**
```
User action → callOpenRouter → fetch (single attempt) → FAIL on network error
```

**Proposed flow:**
```
User action → callOpenRouter → withRetry(fetch) → retry up to 3 times with backoff → eventual success or fail
```

## Solution Design

### 1. Create retry utility (`src/utils/retry.js`)

A reusable `withRetry` function with:
- Configurable max retries (default: 3)
- Exponential backoff: 1s, 2s, 4s delays
- Only retry on network errors (not 4xx client errors)
- Telemetry logging for retry attempts

### 2. Apply to OpenRouter client

Wrap the fetch call in `callOpenRouter` with retry logic:
- Retry on: fetch failures, 5xx server errors, 429 rate limits (with longer delay)
- Do NOT retry on: 401 (invalid key), 402 (no credits), 400 (bad request)

### 3. Add telemetry

Log retry attempts to track effectiveness:
- `api_retry` event with attempt number, delay, final outcome

## Files to Change

| File | Action |
|------|--------|
| `src/utils/retry.js` | **Create** - retry utility function |
| `src/utils/retry.test.js` | **Create** - unit tests |
| `src/api/openrouter-client.js` | **Modify** - wrap fetch with retry |
| `src/api/openrouter-client.test.js` | **Modify** - add retry tests |

## Testing Plan

### Unit Tests (retry.js)
- [x] Succeeds on first attempt (no retry needed)
- [x] Retries on network error and eventually succeeds
- [x] Retries with exponential backoff (1s, 2s, 4s)
- [x] Gives up after max retries
- [x] Does not retry non-retryable errors
- [x] Logs telemetry for each retry attempt

### Integration Tests (openrouter-client.js)
- [x] Retries fetch failures
- [x] Retries 5xx server errors
- [x] Retries 429 with extended delay
- [x] Does NOT retry 401/402/400

### Manual Tests
- [ ] Quiz generation works normally
- [ ] Explanation generation works normally
- [ ] Network throttling in DevTools shows retry behavior

## Implementation Steps

- [x] 1. Write failing tests for retry utility
- [x] 2. Implement `src/utils/retry.js`
- [x] 3. Tests pass
- [x] 4. Write failing tests for openrouter-client retry integration
- [x] 5. Modify `openrouter-client.js` to use retry
- [x] 6. All tests pass
- [ ] 7. Manual testing
- [x] 8. Create PR

## Acceptance Criteria

From issue #88:
- [x] Retry logic implemented for API calls
- [x] Exponential backoff with configurable parameters
- [x] Telemetry logs retry attempts
- [x] Unit tests for retry logic
- [ ] Network error rate decreases in subsequent telemetry reports (post-deploy)
