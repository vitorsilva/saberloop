# Phase 48: JSDoc Configuration & Type Checking

## Overview

Configure JSDoc-based type checking to improve code quality and developer experience without migrating to TypeScript. Enable IDE intelligence, catch type errors at edit-time, and establish type definitions for core data structures.

## Problem Statement

**Current State:**
- JSDoc comments exist across 17 files (~128 annotations)
- Good coverage in services (`quiz-service.js`, `auth-service.js`)
- No `jsconfig.json` - VS Code type checking disabled
- No custom type definitions for complex objects (Quiz, Question, Session)
- No automated type checking in CI

**Desired State:**
- `jsconfig.json` enables type checking with `checkJs: true`
- Custom type definitions (`@typedef`) for core data structures
- NPM script for type checking (`npm run typecheck`)
- CI integration (warning mode initially)
- Improved IDE autocomplete and error detection

## Why JSDoc (Not TypeScript)?

| Factor | JSDoc | TypeScript |
|--------|-------|------------|
| Build step | None required | Required |
| Learning curve | Minimal (just comments) | Moderate |
| Gradual adoption | Add per-file/function | All-or-nothing migration |
| Runtime overhead | None | None (compiles away) |
| IDE support | Good (VS Code) | Excellent |
| Best for | Existing vanilla JS projects | New projects, large teams |

**Decision:** JSDoc is the right choice for Saberloop because:
1. Project is vanilla JavaScript with no TypeScript tooling
2. Already using JSDoc in key files
3. Can adopt incrementally without build changes
4. Matches learning-focused nature of the project

---

## Learning Objectives

- Understanding `jsconfig.json` configuration
- Writing `@typedef` for complex object types
- Using `@param`, `@returns`, `@type` effectively
- TypeScript-style JSDoc annotations
- CI integration for type checking

---

## Implementation Plan

### 48.1 - Create jsconfig.json

**File:** `jsconfig.json` (project root)

**Purpose:** Enable JavaScript type checking in VS Code and for CLI validation.

```json
{
  "compilerOptions": {
    "checkJs": true,
    "strict": false,
    "noEmit": true,
    "target": "ES2022",
    "module": "ES2022",
    "moduleResolution": "bundler",
    "resolveJsonModule": true,
    "allowSyntheticDefaultImports": true,
    "skipLibCheck": true,
    "baseUrl": ".",
    "paths": {
      "@/*": ["src/*"]
    }
  },
  "include": ["src/**/*.js"],
  "exclude": ["node_modules", "dist", "tests"]
}
```

**Key options explained:**
- `checkJs: true` - Enable type checking for .js files
- `strict: false` - Start permissive, tighten later
- `noEmit: true` - Don't generate output files
- `target/module: ES2022` - Modern JavaScript features
- `moduleResolution: bundler` - Works with Vite

---

### 48.2 - Create Type Definitions File

**File:** `src/types.js`

**Purpose:** Define shared types for core data structures using `@typedef`.

```javascript
/**
 * @file Type definitions for Saberloop
 *
 * This file contains JSDoc type definitions used throughout the application.
 * Import types using:
 *   import './types.js' // for side effects (registers types)
 * Or reference directly:
 *   @type {import('./types.js').Question}
 */

// ============================================
// Quiz & Question Types
// ============================================

/**
 * A single quiz question
 * @typedef {Object} Question
 * @property {string} question - The question text
 * @property {string[]} options - Array of 4 answer options (A, B, C, D)
 * @property {number} correctIndex - Index of correct answer (0-3)
 * @property {string} [explanation] - Optional explanation of the answer
 * @property {string} [difficulty] - Optional difficulty level
 */

/**
 * Quiz generation result from API
 * @typedef {Object} QuizResult
 * @property {string} language - Language code (e.g., 'EN-US', 'PT-PT')
 * @property {Question[]} questions - Array of generated questions
 */

/**
 * A saved quiz session
 * @typedef {Object} QuizSession
 * @property {number} [id] - Unique session ID (auto-generated by IndexedDB)
 * @property {string} topic - Quiz topic
 * @property {string} gradeLevel - Education level
 * @property {Question[]} questions - Array of questions
 * @property {number[]} userAnswers - User's selected answers (indices)
 * @property {number} score - Number of correct answers
 * @property {number} totalQuestions - Total number of questions
 * @property {string} timestamp - ISO timestamp of when quiz was taken
 * @property {string} [language] - Language code used for generation
 */

// ============================================
// Settings Types
// ============================================

/**
 * Application settings
 * @typedef {Object} AppSettings
 * @property {string} gradeLevel - Default education level
 * @property {string} questionsPerQuiz - Number of questions ('5', '10', '15')
 * @property {string} language - UI language code
 * @property {boolean} soundEnabled - Whether sounds are enabled
 * @property {boolean} hapticEnabled - Whether haptic feedback is enabled
 */

// ============================================
// Auth Types
// ============================================

/**
 * OpenRouter authentication state
 * @typedef {Object} AuthState
 * @property {boolean} isConnected - Whether user is authenticated
 * @property {string|null} apiKey - OpenRouter API key (or null)
 * @property {string|null} userCode - User's OpenRouter code
 */

/**
 * OAuth callback parameters
 * @typedef {Object} OAuthCallback
 * @property {string} code - Authorization code from OAuth flow
 * @property {string} [error] - Error code if OAuth failed
 * @property {string} [error_description] - Human-readable error message
 */

// ============================================
// API Types
// ============================================

/**
 * Options for quiz generation
 * @typedef {Object} GenerateOptions
 * @property {string} [language='en'] - Language code for generation
 * @property {number} [questionCount=5] - Number of questions to generate
 * @property {Question[]} [previousQuestions=[]] - Questions to avoid duplicating
 */

/**
 * Options for explanation generation
 * @typedef {Object} ExplanationOptions
 * @property {string} [language='en'] - Language code for explanation
 */

// ============================================
// Telemetry Types
// ============================================

/**
 * Telemetry event
 * @typedef {Object} TelemetryEvent
 * @property {string} event - Event name
 * @property {Object} [data] - Event-specific data
 * @property {string} timestamp - ISO timestamp
 * @property {string} sessionId - Browser session ID
 */

// ============================================
// Router Types
// ============================================

/**
 * Route definition
 * @typedef {Object} Route
 * @property {string} path - URL path pattern
 * @property {Function} handler - View handler function
 * @property {string} [title] - Page title
 */

/**
 * Navigation options
 * @typedef {Object} NavigateOptions
 * @property {boolean} [replace=false] - Replace current history entry
 * @property {Object} [state] - State to pass to the route
 */

export {};
```

---

### 48.3 - Add Type Checking Script

**File:** `package.json`

**Add script:**
```json
{
  "scripts": {
    "typecheck": "tsc --noEmit --allowJs --checkJs --skipLibCheck --target ES2022 --moduleResolution bundler src/**/*.js"
  }
}
```

**Alternative (simpler, uses jsconfig.json):**
```json
{
  "scripts": {
    "typecheck": "tsc -p jsconfig.json --noEmit"
  }
}
```

**Note:** This requires TypeScript as a dev dependency for the CLI. VS Code uses its built-in TypeScript for real-time checking.

---

### 48.4 - Install TypeScript (Dev Dependency)

TypeScript CLI is needed for the `npm run typecheck` command:

```bash
npm install --save-dev typescript
```

**Why?** Even though we're not writing TypeScript, the `tsc` CLI can check JavaScript files with JSDoc annotations.

---

### 48.5 - Update CI Workflow

**File:** `.github/workflows/test.yml`

**Add step (warning mode):**
```yaml
- name: Type check (warning)
  run: npm run typecheck || true
```

**Position:** After "Check architecture rules" step.

---

### 48.6 - Improve Key File JSDoc Coverage

**Priority files to enhance (based on complexity/usage):**

1. **`src/core/db.js`** - Add types for database operations
2. **`src/core/state.js`** - Type the global state object
3. **`src/api/openrouter-client.js`** - API request/response types
4. **`src/views/QuizView.js`** - Quiz state and rendering

**Example enhancement for db.js:**

```javascript
/**
 * Save a quiz session to the database
 * @param {QuizSession} session - The session to save
 * @returns {Promise<number>} The ID of the saved session
 */
export async function saveSession(session) {
  // ...
}
```

---

## File Changes Summary

| File | Change Type | Description |
|------|-------------|-------------|
| `jsconfig.json` | Create | Enable JS type checking |
| `src/types.js` | Create | Shared type definitions |
| `package.json` | Modify | Add typecheck script |
| `.github/workflows/test.yml` | Modify | Add type check step |
| `src/core/db.js` | Modify | Improve JSDoc coverage |
| `src/core/state.js` | Modify | Improve JSDoc coverage |
| `src/api/openrouter-client.js` | Modify | Improve JSDoc coverage |

---

## Testing Plan

### Verification Steps

1. **VS Code Integration:**
   - [ ] Open a `.js` file in VS Code
   - [ ] Hover over a function - see type info
   - [ ] Intentionally add type error - see red squiggle
   - [ ] Autocomplete works for typed objects

2. **CLI Type Check:**
   - [ ] `npm run typecheck` runs without fatal errors
   - [ ] Type errors are reported (if any exist)
   - [ ] Exit code is 0 when no errors

3. **CI Integration:**
   - [ ] GitHub Actions runs typecheck step
   - [ ] Failures don't block the build (warning mode)
   - [ ] Type errors visible in CI logs

---

## Commits Plan

1. `chore: add jsconfig.json for JS type checking`
   - Create jsconfig.json

2. `feat: add type definitions for core data structures`
   - Create src/types.js with @typedef declarations

3. `chore: add typecheck npm script`
   - Install typescript as dev dependency
   - Add typecheck script to package.json

4. `ci: add type checking step to GitHub Actions`
   - Update test.yml with typecheck step

5. `docs: improve JSDoc coverage in core modules`
   - Enhance db.js, state.js, openrouter-client.js
   - Reference types from types.js

6. `docs: add Phase 47 documentation`
   - This phase document

---

## Success Criteria

- [ ] `jsconfig.json` created and VS Code recognizes it
- [ ] `src/types.js` defines core types (Question, QuizSession, etc.)
- [ ] `npm run typecheck` runs successfully
- [ ] VS Code shows type info on hover
- [ ] VS Code autocompletes typed properties
- [ ] CI runs typecheck in warning mode
- [ ] No increase in false positives during development

---

## Out of Scope

- TypeScript migration (this is JSDoc-only)
- Strict mode enforcement (start permissive)
- 100% type coverage (focus on public APIs and complex types)
- Type checking test files (excluded in jsconfig.json)
- Third-party library type definitions (@types/*)

---

## Future Enhancements (Optional)

After Phase 47 is complete, consider:

1. **Phase 48.1: Strict Mode Migration**
   - Enable `strict: true` in jsconfig.json
   - Fix resulting type errors one file at a time

2. **Phase 48.2: Library Types**
   - Add `@types/node` for Node.js scripts
   - Consider types for i18next, etc.

3. **Phase 48.3: Promote to Error**
   - Change CI from warning to blocking
   - After 2-4 weeks of stable operation

---

## Related Files

- Configuration: `jsconfig.json`, `package.json`
- Types: `src/types.js`
- Core modules: `db.js`, `state.js`, `settings.js`
- Services: `quiz-service.js`, `auth-service.js`
- API: `api.real.js`, `api.mock.js`, `openrouter-client.js`

---

## References

- [JSDoc Reference](https://jsdoc.app/)
- [TypeScript JSDoc Support](https://www.typescriptlang.org/docs/handbook/jsdoc-supported-types.html)
- [VS Code JavaScript Type Checking](https://code.visualstudio.com/docs/nodejs/working-with-javascript#_type-checking-javascript)
- [jsconfig.json Reference](https://code.visualstudio.com/docs/languages/jsconfig)
